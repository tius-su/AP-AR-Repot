<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Roda Toko - Aplikasi Transaksi</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="apple-touch-icon" href="/logo192.png"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary-color: #3498db; /* Biru */
            --secondary-color: #2c3e50; /* Biru Gelap */
            --success-color: #2ecc71; /* Hijau */
            --danger-color: #e74c3c; /* Merah */
            --warning-color: #f39c12; /* Oranye */
            --info-color: #1abc9c; /* Teal */
            --light-bg: #f5f7fa; /* Abu-abu terang */
            --dark-text: #333;
            --light-text: #f8f8f8;
            --border-color: #ddd;
            --input-bg: #fff;
            --card-bg: #fff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px; /* Adjust for mobile wrapping */
        }

        .logo {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: var(--primary-color);
            font-weight: bold;
            overflow: hidden;
        }

        .logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .store-info h1 {
            margin: 0;
            font-size: 1.8em;
            color: white;
        }

        .store-info p {
            margin: 0;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }

        .date-display {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* Navigation Styles */
        nav {
            background-color: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 0; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            min-height: 50px; 
            overflow: hidden; /* Prevent overflow on nav container itself */
        }

        nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px; 
            flex-grow: 1;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            overflow-x: auto; /* Enable horizontal scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
            -ms-overflow-style: -ms-autohiding-scrollbar; /* For IE/Edge */
            white-space: nowrap; /* Keep all tabs in one line */
            flex-grow: 1; /* Allow tabs to take available space */
            border-bottom: 3px solid transparent; 
        }
        
        /* Scrollbar styles for webkit browsers */
        .nav-tabs::-webkit-scrollbar {
            height: 5px; 
        }
        .nav-tabs::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        .nav-tabs::-webkit-scrollbar-track {
            background: var(--light-bg);
        }

        .nav-tabs li {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            color: var(--dark-text);
            border-bottom: 3px solid transparent;
            flex-shrink: 0; /* Prevent items from shrinking */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tabs li:hover:not(.active) {
            background-color: var(--light-bg);
        }

        .nav-tabs li.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: var(--light-bg);
        }

        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 12px; 
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em; 
            transition: background-color 0.3s ease;
            margin-left: 15px; 
            flex-shrink: 0; /* Prevent from shrinking */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        /* Main Content Styles */
        main {
            padding: 20px 0;
        }

        .tab-pane {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none; /* Default hidden */
            animation: fadeIn 0.5s ease-out;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styling */
        h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.6em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%; /* Make input fields full width */
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: var(--input-bg);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Prevent number input spin buttons */
        .form-group input[type="number"]::-webkit-inner-spin-button,
        .form-group input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .form-group input[type="number"] {
            -moz-appearance: textfield;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-grow: 1; /* Allow buttons to grow and fill space */
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-1px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-text);
        }

        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-1px);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #17a2b8;
            transform: translateY(-1px);
        }


        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow: hidden; /* For rounded corners */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* subtle shadow */
        }

        table thead th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
            white-space: nowrap; /* Prevent headers from wrapping too much */
            border: 1px solid var(--secondary-color); /* Ensure border color matches background */
        }
        table th, table td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }

        table tbody tr:nth-child(even) {
            background-color: var(--light-bg);
        }

        table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .table-action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .table-action-buttons .btn {
            padding: 6px 10px;
            font-size: 0.85em;
            flex-grow: 0;
            width: auto;
        }

        /* Summary Cards (Dashboard) */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .summary-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        .summary-card.customer-card i { color: var(--primary-color); }
        .summary-card.supplier-card i { color: var(--info-color); }
        .summary-card.receivable-card i { color: var(--success-color); }
        .summary-card.debt-card i { color: var(--danger-color); }

        .card-title {
            font-size: 1.1rem;
            color: var(--dark-gray);
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* Report Filters & Summary */
        .report-filters-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--light-bg);
            border-radius: 8px;
        }
        .report-filters-group .form-group {
            margin-bottom: 0;
            flex-basis: calc(50% - 15px); /* Half width on larger screens */
            min-width: 250px; /* Minimum width before stacking */
        }
        .report-filters-group .btn-group {
            margin-top: 0;
            flex-basis: 100%; /* Buttons take full width */
        }
        
        .report-summary-box {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-bg);
            border-radius: 8px;
            font-weight: bold;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .report-summary-box p {
            margin: 5px 0;
        }
        .report-summary-box .value {
            color: var(--primary-color);
        }
        .report-summary-box .value.positive { color: var(--success-color); }
        .report-summary-box .value.negative { color: var(--danger-color); }


        /* Saldo Bank List */
        #bank-accounts-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        #bank-accounts-list li {
            background-color: var(--light-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #bank-accounts-list li .balance {
            font-size: 1.2em;
            color: var(--primary-color);
            font-weight: 700;
        }
        #bank-accounts-list li .bank-actions .btn {
            padding: 8px 12px;
            font-size: 0.9em;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: center;
            }
            .logo-section {
                width: 100%;
                justify-content: center;
            }
            .store-info {
                text-align: center;
                width: 100%;
                margin-top: 10px;
            }
            .date-display {
                margin-top: 15px;
                width: 100%;
                justify-content: center;
            }
            /* Nav bar specific adjustments for better mobile scrolling */
            nav .container {
                flex-direction: column; /* Stack nav-tabs and logout button */
                align-items: flex-start; /* Align contents to start */
                padding: 0; /* Remove horizontal padding here, let nav-tabs handle it */
            }
            .nav-tabs {
                width: 100%; /* Take full width for scrolling */
                justify-content: flex-start;
                padding: 0 15px; /* Horizontal padding for scrollable area */
                margin-bottom: 10px; /* Space below tabs */
                flex-wrap: nowrap; /* Ensure no wrapping, only scrolling */
            }
            .nav-tabs li {
                font-size: 13px;
                padding: 10px 12px;
            }
            .logout-btn {
                margin: 0 15px 10px 15px; /* Margin bottom for separation */
                width: calc(100% - 30px); /* Fill width with margin */
                text-align: center; /* Center text in button */
            }

            .form-group input, .form-group textarea, .form-group select {
                width: 100%;
            }
            .btn-group .btn {
                flex-basis: 100%; /* Stack buttons */
            }
            .report-filters-group .form-group {
                flex-basis: 100%; /* Stack filters */
            }
            .summary-cards {
                grid-template-columns: 1fr; /* Stack cards on very small screens */
            }

            /* Table cells smaller on mobile for readability */
            table th, table td {
                padding: 8px; /* Reduced padding */
                font-size: 0.9em; /* Smaller font */
            }
            /* You might choose to hide some columns or make them scrollable */
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo" id="app-logo">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="store-info">
                        <h1 id="header-store-name">Roda Toko</h1>
                        <p id="header-store-address">Jl. Sudirman No. 123, Jakarta Pusat</p>
                    </div>
                </div>
                <div class="date-display">
                    <i class="fas fa-calendar"></i> <span id="current-date"></span>
                </div>
            </div>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul class="nav-tabs">
                <li data-tab="dashboard-tab"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li data-tab="transaction-tab" class="active"><i class="fas fa-exchange-alt"></i> Transaksi</li>
                <li data-tab="master-data-tab"><i class="fas fa-users"></i> Master Data</li>
                <li data-tab="report-tab"><i class="fas fa-file-alt"></i> Laporan</li>
                <li data-tab="bank-accounts-tab"><i class="fas fa-university"></i> Saldo Bank</li>
                <li data-tab="settings-tab"><i class="fas fa-cog"></i> Pengaturan</li>
            </ul>
            <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </nav>

    <main>
        <div class="container">
            <div id="dashboard-tab" class="tab-pane">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <div class="summary-cards">
                    <div class="summary-card customer-card">
                        <i class="fas fa-users"></i>
                        <div class="card-title">Total Customer</div>
                        <div class="card-value" id="total-customer-count">0</div>
                    </div>
                    <div class="summary-card supplier-card">
                        <i class="fas fa-truck-loading"></i>
                        <div class="card-title">Total Supplier</div>
                        <div class="card-value" id="total-supplier-count">0</div>
                    </div>
                    <div class="summary-card receivable-card">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div class="card-title">Total Piutang</div>
                        <div class="card-value" id="total-receivable-amount">Rp 0</div>
                    </div>
                    <div class="summary-card debt-card">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <div class="card-title">Total Hutang</div>
                        <div class="card-value" id="total-debt-amount">Rp 0</div>
                    </div>
                </div>

                <h3>Transaksi Terbaru</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan</th>
                            <th>Nama/Kategori</th>
                            <th>Tipe Transaksi</th>
                            <th>Jumlah</th>
                        </tr>
                    </thead>
                    <tbody id="recent-transactions-table-body">
                        </tbody>
                </table>
            </div>

            <div id="transaction-tab" class="tab-pane active">
                <h2><i class="fas fa-exchange-alt"></i> Catat Transaksi Baru</h2>
                <div class="form-group">
                    <label for="transaction-date">Tanggal Transaksi</label>
                    <input type="date" id="transaction-date">
                </div>
                <div class="form-group">
                    <label for="transaction-amount">Jumlah Transaksi (Rp)</label>
                    <input type="number" id="transaction-amount" placeholder="Contoh: 500000" step="any" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label for="transaction-description">Keterangan</label>
                    <textarea id="transaction-description" placeholder="Pembelian barang, Pembayaran gaji, dll."></textarea>
                </div>
                <div class="form-group">
                    <label for="transaction-master-data">Jenis Pihak / Kategori</label>
                    <select id="transaction-master-data">
                        <option value="">Pilih Jenis Pihak / Kategori</option>
                        </select>
                </div>
                <div class="form-group">
                    <label for="transaction-debet">Debet</label>
                    <input type="text" id="transaction-debet" readonly value="Rp 0">
                </div>
                <div class="form-group">
                    <label for="transaction-kredit">Kredit</label>
                    <input type="text" id="transaction-kredit" readonly value="Rp 0">
                </div>
                <div class="form-group">
                    <label for="transaction-balance">Saldo Per Nama (Prediksi)</label>
                    <input type="text" id="transaction-balance" readonly value="Rp 0">
                </div>
                <div class="btn-group">
                    <button id="save-transaction-btn" class="btn btn-primary"><i class="fas fa-save"></i> Simpan Transaksi</button>
                    <button id="reset-form-btn" class="btn btn-danger"><i class="fas fa-redo"></i> Reset Form</button>
                </div>
            </div>

            <div id="master-data-tab" class="tab-pane">
                <h2><i class="fas fa-users"></i> Manajemen Master Data</h2>
                <div class="form-group">
                    <label for="master-data-name">Nama/Kategori Baru</label>
                    <input type="text" id="master-data-name" placeholder="Contoh: Supplier A, Pelanggan B, Listrik">
                </div>
                <div class="form-group">
                    <label for="master-data-type">Tipe</label>
                    <select id="master-data-type">
                        <option value="">Pilih Tipe</option>
                        <option value="Supplier">Supplier</option>
                        <option value="Customer">Customer</option>
                        <option value="Lain-lain">Lain-lain</option>
                    </select>
                </div>
                <button id="add-master-data-btn" class="btn btn-success"><i class="fas fa-plus"></i> Tambah Master Data</button>

                <h3>Daftar Master Data</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nama/Kategori</th>
                            <th>Tipe</th>
                            <th>Saldo</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="master-data-table-body">
                        </tbody>
                </table>
            </div>

            <div id="report-tab" class="tab-pane">
                <h2><i class="fas fa-file-alt"></i> Laporan Transaksi</h2>
                <div class="report-filters-group">
                    <div class="form-group">
                        <label for="report-start-date">Dari Tanggal:</label>
                        <input type="date" id="report-start-date">
                    </div>
                    <div class="form-group">
                        <label for="report-end-date">Sampai Tanggal:</label>
                        <input type="date" id="report-end-date">
                    </div>
                    <div class="form-group">
                        <label for="filter-master-data-type">Filter Tipe Pihak:</label>
                        <select id="filter-master-data-type">
                            <option value="all">Semua Tipe</option>
                            <option value="Customer">Customer</option>
                            <option value="Supplier">Supplier</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="filter-by-name-input">Filter Berdasarkan Nama:</label>
                        <input type="text" id="filter-by-name-input" placeholder="Cari nama...">
                    </div>
                    <div class="btn-group">
                        <button id="generate-report-btn" class="btn btn-primary"><i class="fas fa-search"></i> Buat Laporan</button>
                        <button id="download-pdf-btn" class="btn btn-danger"><i class="fas fa-file-pdf"></i> Unduh PDF</button>
                        <button id="export-excel-btn" class="btn btn-success"><i class="fas fa-file-excel"></i> Export Excel</button>
                        <button id="share-whatsapp-btn" class="btn btn-info"><i class="fab fa-whatsapp"></i> Share WhatsApp</button>
                    </div>
                </div>

                <h3>Detail Transaksi</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th>Nama/Kategori</th>
                                <th>Tipe</th>
                                <th>Debet</th>
                                <th>Kredit</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body">
                            </tbody>
                    </table>
                </div>

                <div class="report-summary-box">
                    <p>Total Debet: <span class="value" id="total-debet-report">Rp 0</span></p>
                    <p>Total Kredit: <span class="value" id="total-kredit-report">Rp 0</span></p>
                    <p>Saldo Akhir: <span class="value" id="final-balance-report">Rp 0</span></p>
                </div>

                <h3 style="margin-top: 40px;"><i class="fas fa-balance-scale"></i> Laporan Saldo per Customer/Supplier</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nama/Kategori</th>
                            <th>Tipe</th>
                            <th>Saldo Akhir</th>
                        </tr>
                    </thead>
                    <tbody id="master-data-balance-report-body">
                        </tbody>
                </table>
            </div>

            <div id="bank-accounts-tab" class="tab-pane">
                <h2><i class="fas fa-university"></i> Manajemen Saldo Bank</h2>
                <div class="form-group">
                    <label for="bank-account-name">Nama Bank/Akun</label>
                    <input type="text" id="bank-account-name" placeholder="Contoh: BCA, Kas Tunai">
                </div>
                <div class="form-group">
                    <label for="bank-account-balance">Saldo Awal (Rp)</label>
                    <input type="number" id="bank-account-balance" placeholder="Contoh: 10000000" step="any" inputmode="decimal">
                </div>
                <div class="btn-group">
                    <button id="add-bank-account-btn" class="btn btn-success"><i class="fas fa-plus"></i> Tambah Akun Bank</button>
                </div>

                <h3>Daftar Akun Bank</h3>
                <ul id="bank-accounts-list">
                    </ul>

                <h3 style="margin-top: 40px;"><i class="fas fa-file-invoice-dollar"></i> Laporan Outstanding Saldo Bank / Mutasi Kas</h3>
                <p>Laporan ini menyajikan mutasi kas/bank dari semua transaksi yang masuk.</p>
                 <div class="report-filters-group">
                    <div class="form-group">
                        <label for="bank-report-start-date">Dari Tanggal:</label>
                        <input type="date" id="bank-report-start-date">
                    </div>
                    <div class="form-group">
                        <label for="bank-report-end-date">Sampai Tanggal:</label>
                        <input type="date" id="bank-report-end-date">
                    </div>
                    <div class="form-group">
                        <label for="bank-report-account-select">Pilih Akun Bank:</label>
                        <select id="bank-report-account-select">
                            <option value="all">Semua Akun Bank</option>
                            </select>
                    </div>
                     <div class="btn-group">
                        <button id="generate-bank-report-btn" class="btn btn-primary"><i class="fas fa-search"></i> Buat Laporan Bank</button>
                        <button id="download-bank-pdf-btn" class="btn btn-danger"><i class="fas fa-file-pdf"></i> Unduh PDF Bank</button>
                     </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan Transaksi</th>
                            <th>Akun Bank</th>
                            <th>Debit (Masuk)</th>
                            <th>Kredit (Keluar)</th>
                            <th>Saldo Akhir Akun</th>
                        </tr>
                    </thead>
                    <tbody id="bank-outstanding-report-body">
                        </tbody>
                </table>
                <div class="report-summary-box">
                    <p>Total Pemasukan Kas/Bank: <span class="value" id="total-bank-debet">Rp 0</span></p>
                    <p>Total Pengeluaran Kas/Bank: <span class="value" id="total-bank-kredit">Rp 0</span></p>
                    <p>Saldo Akhir Kas/Bank (Periode): <span class="value" id="final-bank-balance-period">Rp 0</span></p>
                    <p>Total Saldo Semua Akun Bank: <span class="value" id="total-current-bank-balance">Rp 0</span></p>
                </div>
            </div>

            <div id="settings-tab" class="tab-pane">
                <h2><i class="fas fa-cog"></i> Pengaturan Aplikasi</h2>
                <div id="settings-form">
                    <div class="form-group">
                        <label for="store-name-input">Nama Toko/Bisnis</label>
                        <input type="text" id="store-name-input" placeholder="Contoh: Toko Maju Jaya">
                    </div>
                    <div class="form-group">
                        <label for="store-address-input">Alamat Toko/Bisnis</label>
                        <input type="text" id="store-address-input" placeholder="Contoh: Jl. Merdeka No. 45, Jakarta">
                    </div>
                    <div class="form-group">
                        <label for="logo-url-input">URL Logo (Contoh: /logo.png)</label>
                        <input type="text" id="logo-url-input" placeholder="Contoh: /logo.png atau https://example.com/logo.jpg">
                        <small>Masukkan URL logo yang bisa diakses publik. Jika logo berada di root hosting Anda (misal GitHub Pages atau Firebase Hosting), gunakan `/nama_file_anda.png`.</small>
                    </div>
                    <div class="btn-group">
                        <button id="save-settings-btn" class="btn btn-primary"><i class="fas fa-save"></i> Simpan Pengaturan</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
</html>

<script>
    // GANTI DENGAN KONFIGURASI FIREBASE ANDA YANG SEBENARNYA!
    // Pastikan ini sama persis dengan yang ada di Firebase Console Anda (Project settings -> Your apps -> Web app)
    const firebaseConfig = {
        apiKey: "AIzaSyCubZ9gYfe2sIiu89yDUPQzsNDy_skU-SQ",
        authDomain: "ap-ar-repot.firebaseapp.com",
        databaseURL: "https://ap-ar-repot-default-rtdb.firebaseio.com",
        projectId: "ap-ar-repot",
        storageBucket: "ap-ar-repot.firebasestorage.app", // Meskipun tidak digunakan langsung, tetap sertakan jika ada di config Anda
        messagingSenderId: "93516660589",
        appId: "1:93516660589:web:2b52d873016de2cb2c6464"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Cek status autentikasi saat aplikasi dimuat
    auth.onAuthStateChanged(user => {
        if (!user) {
            // Jika tidak ada pengguna yang login, arahkan ke halaman login
            console.log("User not logged in, redirecting to login.html");
            window.location.href = 'login.html';
        } else {
            // Pengguna sudah login, lanjutkan inisialisasi aplikasi
            console.log("User logged in:", user.email);
            initializeApp();
        }
    });

    // Fungsi untuk menginisialisasi aplikasi setelah login
    function initializeApp() {
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // --- Global Variables/Caches ---
        let masterData = {}; // Cache master data for dropdowns and balance calculation
        let allBankAccountsData = {}; // Cache all bank account data for reports

        // --- UI Elements (Centralized) ---
        const appTitle = document.getElementById('app-title');
        const headerStoreName = document.getElementById('header-store-name');
        const headerStoreAddress = document.getElementById('header-store-address');
        const appLogo = document.getElementById('app-logo'); // Div for logo container
        const currentDatePicker = document.getElementById('current-date');

        // Transaction Tab Elements
        const transactionDateInput = document.getElementById('transaction-date');
        const transactionAmountInput = document.getElementById('transaction-amount');
        const transactionDescriptionInput = document.getElementById('transaction-description');
        const transactionMasterDataSelect = document.getElementById('transaction-master-data');
        const transactionDebetInput = document.getElementById('transaction-debet');
        const transactionKreditInput = document.getElementById('transaction-kredit');
        const transactionBalanceInput = document.getElementById('transaction-balance');
        const saveTransactionBtn = document.getElementById('save-transaction-btn');
        const resetFormBtn = document.getElementById('reset-form-btn');

        // Master Data Tab Elements
        const masterDataNameInput = document.getElementById('master-data-name');
        const masterDataTypeSelect = document.getElementById('master-data-type');
        const addMasterDataBtn = document.getElementById('add-master-data-btn');
        const masterDataTableBody = document.getElementById('master-data-table-body');

        // Report Tab Elements
        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const filterMasterDataType = document.getElementById('filter-master-data-type'); // New filter
        const filterByNameInput = document.getElementById('filter-by-name-input'); // New filter
        const generateReportBtn = document.getElementById('generate-report-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn'); // New: Excel button
        const shareWhatsappBtn = document.getElementById('share-whatsapp-btn'); // New: WhatsApp button
        const reportTableBody = document.getElementById('report-table-body');
        const totalDebetReport = document.getElementById('total-debet-report');
        const totalKreditReport = document.getElementById('total-kredit-report');
        const finalBalanceReport = document.getElementById('final-balance-report');
        const masterDataBalanceReportBody = document.getElementById('master-data-balance-report-body'); // New: Laporan per Supplier/Customer

        // Bank Accounts Tab Elements
        const bankAccountNameInput = document.getElementById('bank-account-name');
        const bankAccountBalanceInput = document.getElementById('bank-account-balance');
        const addBankAccountBtn = document.getElementById('add-bank-account-btn');
        const bankAccountsList = document.getElementById('bank-accounts-list');
        const bankReportStartDateInput = document.getElementById('bank-report-start-date');
        const bankReportEndDateInput = document.getElementById('bank-report-end-date');
        const bankReportAccountSelect = document.getElementById('bank-report-account-select');
        const generateBankReportBtn = document.getElementById('generate-bank-report-btn');
        const downloadBankPdfBtn = document.getElementById('download-bank-pdf-btn');
        const bankOutstandingReportBody = document.getElementById('bank-outstanding-report-body');
        const totalBankDebet = document.getElementById('total-bank-debet');
        const totalBankKredit = document.getElementById('total-bank-kredit');
        const finalBankBalancePeriod = document.getElementById('final-bank-balance-period');
        const totalCurrentBankBalance = document.getElementById('total-current-bank-balance');


        // Settings Tab Elements
        const settingsStoreNameInput = document.getElementById('store-name-input');
        const settingsStoreAddressInput = document.getElementById('store-address-input');
        const settingsLogoUrlInput = document.getElementById('logo-url-input');
        const saveSettingsBtn = document.getElementById('save-settings-btn');


        // --- Utility Functions ---

        // Format Rupiah (modified to handle number input directly)
        function formatRupiah(number) {
            if (number === null || number === undefined || isNaN(number)) return 'Rp 0';
            // Ensure number is a float
            number = parseFloat(number);
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        // Parse Rupiah string back to number
        function parseRupiah(rupiahString) {
            if (typeof rupiahString !== 'string') return 0;
            // Remove "Rp", dots for thousands, and replace comma with dot for decimals (if any)
            return parseFloat(rupiahString.replace(/[^0-9,-]+/g, "").replace(/\./g, '').replace(',', '.'));
        }

        // --- Date Display ---
        function updateCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDatePicker.textContent = new Date().toLocaleDateString('id-ID', options);
            // Set default date for transaction form to today
            const today = new Date();
            transactionDateInput.value = today.toISOString().split('T')[0];
            bankReportStartDateInput.value = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            bankReportEndDateInput.value = today.toISOString().split('T')[0];
        }
        updateCurrentDate();

        // --- Tab Navigation Logic ---
        const navTabs = document.querySelectorAll('.nav-tabs li');
        const tabPanes = document.querySelectorAll('.tab-pane');

        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and panes
                navTabs.forEach(item => item.classList.remove('active'));
                tabPanes.forEach(pane => pane.classList.remove('active'));

                // Add active class to clicked tab and corresponding pane
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');

                // Trigger specific load functions when a tab is activated
                const activeTabId = tab.dataset.tab;
                if (activeTabId === 'dashboard-tab') {
                    loadDashboardData();
                } else if (activeTabId === 'transaction-tab') {
                    resetTransactionForm(); // Reset form & set today's date
                    loadMasterDataForDropdown(); // Ensure dropdown is fresh
                } else if (activeTabId === 'master-data-tab') {
                    loadMasterData();
                } else if (activeTabId === 'report-tab') {
                    // Set default report dates (current month)
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    reportStartDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
                    reportEndDateInput.value = today.toISOString().split('T')[0];
                    generateReport(); // Auto-generate report for current month
                    loadMasterDataBalanceReport(); // Load balance report for master data
                } else if (activeTabId === 'bank-accounts-tab') {
                    loadBankAccounts();
                    loadBankReportDropdown(); // Populate bank account dropdown for report
                    generateBankReport(); // Generate bank report by default
                } else if (activeTabId === 'settings-tab') {
                    loadSettings();
                }
            });
        });

        // Activate Dashboard tab as default on app initialization
        document.querySelector('.nav-tabs li[data-tab="dashboard-tab"]').click();


        // --- Firebase Data & UI Management Functions ---

        // Settings (Store Name, Address, Logo)
        function loadSettings() {
            database.ref('storeSettings').once('value', snapshot => {
                const settings = snapshot.val();
                if (settings) {
                    headerStoreName.textContent = settings.storeName || 'Roda Toko';
                    headerStoreAddress.textContent = settings.storeAddress || 'Jl. Sudirman No. 123, Jakarta Pusat';
                    appTitle.textContent = (settings.storeName || 'Roda Toko') + ' - Aplikasi Transaksi'; // Update browser tab title

                    settingsStoreNameInput.value = settings.storeName || '';
                    settingsStoreAddressInput.value = settings.storeAddress || '';
                    settingsLogoUrlInput.value = settings.logoUrl || '';

                    // Update logo display in header
                    if (settings.logoUrl) {
                        appLogo.innerHTML = `<img src="${settings.logoUrl}" alt="Logo Toko">`;
                    } else {
                        appLogo.innerHTML = `<i class="fas fa-store"></i>`; // Default icon if no logo
                    }
                } else {
                    // Set default values if no settings exist in DB
                    headerStoreName.textContent = 'Roda Toko';
                    headerStoreAddress.textContent = 'Jl. Sudirman No. 123, Jakarta Pusat';
                    appTitle.textContent = 'Roda Toko - Aplikasi Transaksi';
                    appLogo.innerHTML = `<i class="fas fa-store"></i>`;
                }
            }, error => {
                console.error("Error loading settings:", error);
                // Fallback to defaults on error
                headerStoreName.textContent = 'Roda Toko';
                headerStoreAddress.textContent = 'Jl. Sudirman No. 123, Jakarta Pusat';
                appTitle.textContent = 'Roda Toko - Aplikasi Transaksi';
                appLogo.innerHTML = `<i class="fas fa-store"></i>`;
            });
        }
        loadSettings(); // Initial load of settings

        saveSettingsBtn.addEventListener('click', () => {
            const storeName = settingsStoreNameInput.value.trim();
            const storeAddress = settingsStoreAddressInput.value.trim();
            const logoUrl = settingsLogoUrlInput.value.trim(); // Get URL directly from input

            database.ref('storeSettings').set({
                storeName: storeName,
                storeAddress: storeAddress,
                logoUrl: logoUrl,
                timestamp: firebase.database.ServerValue.TIMESTAMP // Track last update
            }).then(() => {
                alert('Pengaturan berhasil disimpan!');
                loadSettings(); // Reload settings to update header and logo
            }).catch(error => {
                console.error("Error saving settings:", error);
                alert('Gagal menyimpan pengaturan: ' + error.message);
            });
        });


        // Master Data (for dropdown and table)
        function loadMasterDataForDropdown() {
            database.ref('masterData').on('value', snapshot => {
                masterData = snapshot.val() || {}; // Cache master data
                transactionMasterDataSelect.innerHTML = '<option value="">Pilih Jenis Pihak / Kategori</option>';
                for (let id in masterData) {
                    const item = masterData[id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${item.name} (${item.type})`;
                    transactionMasterDataSelect.appendChild(option);
                }
            }, error => {
                console.error("Error loading master data for dropdown:", error);
                // Handle error gracefully
            });
        }
        // Initial load for dropdown (important for transaction tab)
        loadMasterDataForDropdown();


        // --- Transaksi Tab Logic ---
        transactionAmountInput.addEventListener('input', calculateDebetKreditBalance); 
        transactionMasterDataSelect.addEventListener('change', calculateDebetKreditBalance);

        function calculateDebetKreditBalance() {
            const amount = parseFloat(transactionAmountInput.value) || 0;
            const masterDataId = transactionMasterDataSelect.value;
            
            // Reset fields
            transactionDebetInput.value = formatRupiah(0);
            transactionKreditInput.value = formatRupiah(0);
            transactionBalanceInput.value = formatRupiah(0);

            if (masterDataId && masterData[masterDataId]) {
                const masterItemType = masterData[masterDataId].type; // 'Supplier', 'Customer', 'Lain-lain'
                const currentBalance = masterData[masterDataId].balance || 0;
                let newBalance = currentBalance;

                // Determine debet/kredit display based on master data type
                if (masterItemType === 'Customer') {
                    transactionDebetInput.value = formatRupiah(amount);
                    newBalance = currentBalance + amount; // If customer, it's a receivable
                } else if (masterItemType === 'Supplier') {
                    transactionKreditInput.value = formatRupiah(amount);
                    newBalance = currentBalance - amount; // If supplier, it's a payable
                } else { // 'Lain-lain'
                    // For 'Lain-lain', show 0 in debet/kredit fields, and current balance
                    // Decision for actual transaction type (debet/kredit) will be made on save
                    newBalance = currentBalance; // No change in balance prediction here for 'Lain-lain'
                }
                
                transactionBalanceInput.value = formatRupiah(newBalance);
            }
        }

        saveTransactionBtn.addEventListener('click', () => {
            const date = transactionDateInput.value; // Get date
            const amount = parseFloat(transactionAmountInput.value) || 0;
            const description = transactionDescriptionInput.value.trim();
            const masterDataId = transactionMasterDataSelect.value;
            const masterDataItem = masterDataId ? masterData[masterDataId] : null;

            if (!date || amount <= 0 || !description || !masterDataId || !masterDataItem) {
                alert('Mohon lengkapi semua data transaksi (Tanggal, Jumlah, Keterangan, Jenis Pihak/Kategori).');
                return;
            }

            // Determine actual transaction type (debet/kredit) for storage based on master data type
            let transactionTypeForDB = '';
            let debetAmount = 0;
            let kreditAmount = 0;

            if (masterDataItem.type === 'Customer') {
                transactionTypeForDB = 'debet'; // Customer: Pemasukan (Piutang)
                debetAmount = amount;
                kreditAmount = 0;
            } else if (masterDataItem.type === 'Supplier') {
                transactionTypeForDB = 'kredit'; // Supplier: Pengeluaran (Hutang)
                debetAmount = 0;
                kreditAmount = amount;
            } else { // 'Lain-lain' type
                // For 'Lain-lain' category, we need to decide if it's debet or kredit.
                // Ask user for 'Lain-lain' type
                if (confirm('Untuk kategori "Lain-lain", apakah transaksi ini Pemasukan? (Jika tidak, akan dianggap Pengeluaran)')) {
                    transactionTypeForDB = 'debet';
                    debetAmount = amount;
                    kreditAmount = 0;
                } else {
                    transactionTypeForDB = 'kredit';
                    debetAmount = 0;
                    kreditAmount = amount;
                }
            }


            const transactionData = {
                date: date, // Store transaction date (YYYY-MM-DD)
                amount: amount, // Store original amount as number
                description: description,
                type: transactionTypeForDB, // 'debet' or 'kredit' determined by master data type
                debet: debetAmount, // Actual debet value
                kredit: kreditAmount, // Actual kredit value
                masterDataId: masterDataId,
                masterDataName: masterDataItem.name,
                masterDataType: masterDataItem.type,
                timestamp: firebase.database.ServerValue.TIMESTAMP // Firebase server timestamp
            };

            database.ref('transactions').push(transactionData)
                .then(() => {
                    alert('Transaksi berhasil disimpan!');
                    // Update balance for the affected master data item
                    updateMasterDataBalance(masterDataId, amount, transactionTypeForDB);
                    resetTransactionForm();
                    // Optional: Reload dashboard/reports if they are visible
                    if (document.getElementById('dashboard-tab').classList.contains('active')) {
                        loadDashboardData();
                    }
                    if (document.getElementById('report-tab').classList.contains('active')) {
                        generateReport();
                        loadMasterDataBalanceReport();
                    }
                })
                .catch(error => {
                    console.error("Error saving transaction:", error);
                    alert('Gagal menyimpan transaksi: ' + error.message);
                });
        });

        // Function to update master data's balance (using Firebase Transaction for safety)
        function updateMasterDataBalance(masterDataId, amount, type) {
            const masterRef = database.ref('masterData/' + masterDataId);
            masterRef.transaction(currentData => {
                if (currentData) {
                    let currentBalance = currentData.balance || 0;
                    if (type === 'debet') { // If it's income/receivable from this master data
                        currentData.balance = currentBalance + amount;
                    } else if (type === 'kredit') { // If it's expense/debt to this master data
                        currentData.balance = currentBalance - amount;
                    }
                }
                return currentData; // Return the updated data (or null to abort)
            }, (error, committed, snapshot) => {
                if (error) {
                    console.error("Master data balance update transaction failed:", error);
                } else if (!committed) {
                    console.log("Master data balance update transaction aborted.");
                } else {
                    console.log("Master data balance updated successfully for:", masterData[masterDataId]?.name);
                }
            });
        }

        resetFormBtn.addEventListener('click', resetTransactionForm);

        function resetTransactionForm() {
            const today = new Date();
            transactionDateInput.value = today.toISOString().split('T')[0]; // Reset date to today
            transactionAmountInput.value = '';
            transactionDescriptionInput.value = '';
            transactionMasterDataSelect.value = ''; // Reset to default "Pilih Nama/Kategori"
            transactionDebetInput.value = formatRupiah(0);
            transactionKreditInput.value = formatRupiah(0);
            transactionBalanceInput.value = formatRupiah(0);
        }


        // --- Dashboard Tab Logic ---
        function loadDashboardData() {
            // Get total customer/supplier count and total debt/receivable
            database.ref('masterData').once('value', snapshot => {
                const data = snapshot.val() || {};
                let customerCount = 0;
                let supplierCount = 0;
                let totalReceivable = 0; // Piutang (saldo positif)
                let totalDebt = 0;      // Hutang (saldo negatif)

                for (let id in data) {
                    const item = data[id];
                    if (item.type === 'Customer') {
                        customerCount++;
                    } else if (item.type === 'Supplier') {
                        supplierCount++;
                    }

                    const balance = item.balance || 0;
                    if (balance > 0) {
                        totalReceivable += balance;
                    } else if (balance < 0) {
                        totalDebt += Math.abs(balance);
                    }
                }
                document.getElementById('total-customer-count').textContent = customerCount;
                document.getElementById('total-supplier-count').textContent = supplierCount;
                document.getElementById('total-receivable-amount').textContent = formatRupiah(totalReceivable);
                document.getElementById('total-debt-amount').textContent = formatRupiah(totalDebt);
            }, error => {
                console.error("Error loading dashboard master data:", error);
            });

            // Get recent transactions (e.g., last 5)
            database.ref('transactions').orderByChild('timestamp').limitToLast(5).once('value', snapshot => {
                const recentTransactionsTableBody = document.getElementById('recent-transactions-table-body');
                recentTransactionsTableBody.innerHTML = '';
                const transactions = [];
                snapshot.forEach(childSnapshot => {
                    transactions.push(childSnapshot.val());
                });

                // Display in reverse chronological order (latest first)
                transactions.reverse().forEach(transaction => {
                    const row = recentTransactionsTableBody.insertRow();
                    const date = new Date(transaction.timestamp).toLocaleDateString('id-ID');
                    row.insertCell(0).textContent = date;
                    row.insertCell(1).textContent = transaction.description;
                    row.insertCell(2).textContent = transaction.masterDataName;
                    // Display type more user-friendly
                    row.insertCell(3).textContent = transaction.type === 'debet' ? 'Pemasukan' : 'Pengeluaran';
                    row.insertCell(4).textContent = formatRupiah(transaction.amount);
                });

                if (transactions.length === 0) {
                    recentTransactionsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada transaksi terbaru.</td></tr>';
                }
            }, error => {
                console.error("Error loading recent transactions for dashboard:", error);
            });
        }


        // --- Master Data Tab Logic ---
        addMasterDataBtn.addEventListener('click', () => {
            const name = masterDataNameInput.value.trim();
            const type = masterDataTypeSelect.value;

            if (!name || !type) {
                alert('Nama dan Tipe Master Data tidak boleh kosong.');
                return;
            }

            database.ref('masterData').push({
                name: name,
                type: type,
                balance: 0, // Initial balance for new master data item
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                alert('Master Data berhasil ditambahkan!');
                masterDataNameInput.value = '';
                masterDataTypeSelect.value = '';
                loadMasterData(); // Refresh master data table
                loadMasterDataForDropdown(); // Refresh dropdown in Transaction tab
            }).catch(error => {
                console.error("Error adding master data:", error);
                alert('Gagal menambahkan Master Data: ' + error.message);
            });
        });

        function loadMasterData() {
            database.ref('masterData').on('value', snapshot => {
                masterDataTableBody.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(id => {
                        const item = data[id];
                        const row = masterDataTableBody.insertRow();
                        row.insertCell(0).textContent = item.name;
                        row.insertCell(1).textContent = item.type;
                        row.insertCell(2).textContent = formatRupiah(item.balance || 0); // Display formatted balance

                        const actionsCell = row.insertCell(3);
                        actionsCell.classList.add('table-action-buttons');

                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                        editBtn.classList.add('btn', 'btn-warning');
                        editBtn.addEventListener('click', () => editMasterData(id, item));

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Hapus';
                        deleteBtn.classList.add('btn', 'btn-danger');
                        deleteBtn.addEventListener('click', () => deleteMasterData(id));

                        actionsCell.appendChild(editBtn);
                        actionsCell.appendChild(deleteBtn);
                    });
                } else {
                    masterDataTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada Master Data.</td></tr>';
                }
            }, error => {
                console.error("Error loading master data table:", error);
                masterDataTableBody.innerHTML = '<tr><td colspan="4" class="text-center" style="color: red;">Gagal memuat Master Data.</td></tr>';
            });
        }

        function editMasterData(id, item) {
            const newName = prompt('Edit Nama:', item.name);
            if (newName === null || newName.trim() === '') return;

            const newType = prompt('Edit Tipe (Supplier/Customer/Lain-lain):', item.type);
            if (newType === null || newType.trim() === '') return;

            database.ref('masterData/' + id).update({
                name: newName.trim(),
                type: newType.trim()
            }).then(() => {
                alert('Master Data berhasil diperbarui!');
                // UI updates are handled by the 'on' listener in loadMasterData()
            }).catch(error => {
                console.error("Error updating master data:", error);
                alert('Gagal memperbarui Master Data: ' + error.message);
            });
        }

        function deleteMasterData(id) {
            if (confirm('Apakah Anda yakin ingin menghapus Master Data ini? Ini akan memengaruhi laporan transaksi terkait.')) {
                database.ref('masterData/' + id).remove()
                    .then(() => {
                        alert('Master Data berhasil dihapus!');
                        // UI updates are handled by the 'on' listener in loadMasterData()
                    })
                    .catch(error => {
                        console.error("Error deleting master data:", error);
                        alert('Gagal menghapus Master Data: ' + error.message);
                    });
            }
        }


        // --- Laporan Tab Logic ---
        generateReportBtn.addEventListener('click', generateReport);
        downloadPdfBtn.addEventListener('click', downloadPdfReport);
        filterMasterDataType.addEventListener('change', generateReport); // Filter report by master data type
        filterByNameInput.addEventListener('input', generateReport); // Filter report by name input

        // Export to Excel (Placeholder)
        exportExcelBtn.addEventListener('click', () => {
            alert('Fungsi Export ke Excel belum diimplementasikan.');
            // Implementasi nyata akan membutuhkan library seperti SheetJS (js-xlsx)
            // Contoh sederhana: convert table HTML ke CSV
            // const table = document.getElementById('report-table-body');
            // let csv = 'Tanggal,Keterangan,Nama/Kategori,Tipe,Debet,Kredit\n';
            // table.querySelectorAll('tr').forEach(row => {
            //     const rowData = [];
            //     row.querySelectorAll('td').forEach(cell => rowData.push(cell.textContent));
            //     csv += rowData.join(',') + '\n';
            // });
            // const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            // const link = document.createElement('a');
            // link.href = URL.createObjectURL(blob);
            // link.download = 'Laporan_Transaksi.csv';
            // link.click();
        });

        // Share via WhatsApp (Placeholder)
        shareWhatsappBtn.addEventListener('click', () => {
            const totalDebet = totalDebetReport.textContent;
            const totalKredit = totalKreditReport.textContent;
            const finalBalance = finalBalanceReport.textContent;
            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;
            const filterType = filterMasterDataType.value;
            const filterName = filterByNameInput.value;

            let message = `Laporan Transaksi\nPeriode: ${startDate} s/d ${endDate}\n`;
            if (filterType !== 'all') {
                message += `Filter Tipe: ${filterType}\n`;
            }
            if (filterName) {
                message += `Filter Nama: ${filterName}\n`;
            }
            message += `\nTotal Debet: ${totalDebet}\n`;
            message += `Total Kredit: ${totalKredit}\n`;
            message += `Saldo Akhir: ${finalBalance}\n\n`;
            message += `Lihat detail di aplikasi.`;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });

        function generateReport() {
            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;
            const selectedMasterDataType = filterMasterDataType.value; // Get selected filter type
            const filterByName = filterByNameInput.value.toLowerCase(); // Get filter name

            if (!startDate || !endDate) {
                alert('Mohon pilih rentang tanggal untuk laporan.');
                return;
            }

            const startTimestamp = new Date(startDate).getTime();
            const endTimestamp = new Date(endDate);
            endTimestamp.setHours(23, 59, 59, 999); 

            database.ref('transactions')
                .orderByChild('timestamp')
                .startAt(startTimestamp)
                .endAt(endTimestamp.getTime())
                .once('value', snapshot => {
                    reportTableBody.innerHTML = '';
                    let totalDebet = 0;
                    let totalKredit = 0;

                    const transactions = [];
                    snapshot.forEach(childSnapshot => {
                        transactions.push(childSnapshot.val());
                    });

                    // Apply filters
                    const filteredTransactions = transactions.filter(transaction => {
                        const matchesType = selectedMasterDataType === 'all' || transaction.masterDataType === selectedMasterDataType;
                        const matchesName = filterByName === '' || (transaction.masterDataName && transaction.masterDataName.toLowerCase().includes(filterByName));
                        return matchesType && matchesName;
                    });

                    // Sort transactions by timestamp (ascending) for consistent display
                    filteredTransactions.sort((a, b) => a.timestamp - b.timestamp);

                    if (filteredTransactions.length === 0) {
                        reportTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada transaksi dalam periode ini atau filter yang dipilih.</td></tr>';
                    } else {
                        filteredTransactions.forEach(transaction => {
                            const row = reportTableBody.insertRow();
                            const date = new Date(transaction.timestamp).toLocaleDateString('id-ID');
                            row.insertCell(0).textContent = date;
                            row.insertCell(1).textContent = transaction.description;
                            row.insertCell(2).textContent = transaction.masterDataName;
                            row.insertCell(3).textContent = transaction.type === 'debet' ? 'Pemasukan' : 'Pengeluaran';
                            // Ensure debet/kredit values are numbers before formatting
                            row.insertCell(4).textContent = formatRupiah(parseFloat(transaction.debet) || 0); 
                            row.insertCell(5).textContent = formatRupiah(parseFloat(transaction.kredit) || 0);
                            
                            totalDebet += (parseFloat(transaction.debet) || 0); 
                            totalKredit += (parseFloat(transaction.kredit) || 0);
                        });
                    }

                    totalDebetReport.textContent = formatRupiah(totalDebet);
                    totalKreditReport.textContent = formatRupiah(totalKredit);
                    const finalBalance = totalDebet - totalKredit;
                    finalBalanceReport.textContent = formatRupiah(finalBalance);
                    // Add class for visual feedback
                    if (finalBalance > 0) finalBalanceReport.classList.add('positive'); else if (finalBalance < 0) finalBalanceReport.classList.add('negative'); else { finalBalanceReport.classList.remove('positive', 'negative'); }
                })
                .catch(error => {
                    console.error("Error generating report:", error);
                    alert('Gagal membuat laporan: ' + error.message);
                });
        }

        // Laporan Saldo per Customer/Supplier
        function loadMasterDataBalanceReport() {
            database.ref('masterData').on('value', snapshot => {
                masterDataBalanceReportBody.innerHTML = '';
                const data = snapshot.val() || {};
                const sortedMasterData = Object.keys(data).map(key => ({ id: key, ...data[key] }))
                                        .sort((a, b) => a.name.localeCompare(b.name));

                if (sortedMasterData.length === 0) {
                    masterDataBalanceReportBody.innerHTML = '<tr><td colspan="3" class="text-center">Belum ada data Customer/Supplier.</td></tr>';
                } else {
                    sortedMasterData.forEach(item => {
                        // Only show Customer and Supplier in this report, assuming 'Lain-lain' might not be in this summary
                        if (item.type === 'Customer' || item.type === 'Supplier') {
                            const row = masterDataBalanceReportBody.insertRow();
                            row.insertCell(0).textContent = item.name;
                            row.insertCell(1).textContent = item.type;
                            row.insertCell(2).textContent = formatRupiah(item.balance || 0);
                        }
                    });
                     // If after filtering, no Customer/Supplier left
                     if (masterDataBalanceReportBody.rows.length === 0) {
                        masterDataBalanceReportBody.innerHTML = '<tr><td colspan="3" class="text-center">Tidak ada Customer atau Supplier.</td></tr>';
                    }
                }
            }, error => {
                console.error("Error loading master data balance report:", error);
                masterDataBalanceReportBody.innerHTML = '<tr><td colspan="3" class="text-center" style="color: red;">Gagal memuat laporan saldo.</td></tr>';
            });
        }

        // Fungsi untuk mengunduh laporan sebagai PDF (membutuhkan jsPDF dan html2canvas)
        function downloadPdfReport() {
            // Load jsPDF and html2canvas dynamically if not already loaded
            if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
                const jspdfScript = document.createElement('script');
                jspdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(jspdfScript);

                const html2canvasScript = document.createElement('script');
                html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                document.head.appendChild(html2canvasScript);

                jspdfScript.onload = () => { // Ensure html2canvas is loaded after jspdf for some versions
                    html2canvasScript.onload = () => {
                        setTimeout(() => generatePdf(), 100); // Small delay to ensure everything is ready
                    };
                };
            } else {
                generatePdf();
            }

            function generatePdf() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4'); // Portrait, points, A4

                const reportTable = document.querySelector('#report-tab table:first-of-type'); // Get the table element (Detail Transaksi)
                const balanceTable = document.querySelector('#report-tab table:last-of-type'); // Get the table element (Laporan Saldo)

                // Function to add a table to PDF
                const addTableToPdf = (tableElement, title, startYPos) => {
                    return html2canvas(tableElement, { scale: 2 }).then(canvas => { // Higher scale for better quality
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = doc.internal.pageSize.getWidth() - 40; // Page width - margin
                        const imgHeight = canvas.height * imgWidth / canvas.width;
                        let position = startYPos; // Initial Y position for image

                        // Add title for table
                        if (title) {
                            doc.setFontSize(14);
                            doc.text(title, 20, position);
                            position += 15; // Space after title
                        }

                        doc.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                        return imgHeight + 20; // Return height used (image + padding)
                    });
                };

                // Main Report Info
                doc.setFontSize(18);
                doc.text("Laporan Transaksi", 20, 30);
                doc.setFontSize(10);
                doc.text(`Periode: ${reportStartDateInput.value} s/d ${reportEndDateInput.value}`, 20, 45);
                doc.text(`Dicetak: ${new Date().toLocaleDateString('id-ID')}`, 20, 55);
                // Add filter info
                if (filterMasterDataType.value !== 'all') {
                    doc.text(`Filter Tipe Pihak: ${filterMasterDataType.value}`, 20, 70);
                }
                if (filterByNameInput.value !== '') {
                    doc.text(`Filter Nama: ${filterByNameInput.value}`, 20, 85);
                }


                let currentY = 100; // Starting Y position after header info and filter

                addTableToPdf(reportTable, "Detail Transaksi", currentY).then(heightOfFirstTable => {
                    currentY += heightOfFirstTable; // Update Y for next element

                    // Check if new page is needed for summary and second table
                    if (currentY + 100 > doc.internal.pageSize.getHeight()) { // Estimate space needed for summary + next table title
                        doc.addPage();
                        currentY = 30; // Reset Y for new page
                    }

                    // Add summary box
                    doc.setFontSize(10);
                    doc.text(`Total Debet: ${totalDebetReport.textContent}`, 20, currentY);
                    doc.text(`Total Kredit: ${totalKreditReport.textContent}`, 20, currentY + 15);
                    doc.text(`Saldo Akhir: ${finalBalanceReport.textContent}`, 20, currentY + 30);
                    currentY += 45; // Space for summary

                    // Check if new page is needed for second table
                    if (currentY + 50 > doc.internal.pageSize.getHeight()) { // Estimate space needed for next table title
                        doc.addPage();
                        currentY = 30; // Reset Y for new page
                    }

                    // Add second table (Master Data Balance)
                    addTableToPdf(balanceTable, "Laporan Saldo per Customer/Supplier", currentY).then(() => {
                        doc.save(`Laporan_Transaksi_Roda_Toko_${reportStartDateInput.value}_${reportEndDateInput.value}.pdf`);
                        alert('Laporan PDF berhasil dibuat dan diunduh!');
                    });
                }).catch(error => {
                    console.error("Error generating PDF:", error);
                    alert("Gagal membuat laporan PDF. Pastikan tabel terlihat di layar atau coba lagi.");
                });
            }
        }


        // --- Saldo Bank Tab Logic ---
        bankAccountBalanceInput.addEventListener('input', function() {
            // Format to Rupiah when user types (on the fly visual)
            let value = this.value.replace(/\./g, ''); // Remove existing dots for formatting
            if (!isNaN(parseFloat(value))) {
                this.value = formatRupiah(parseFloat(value)).replace('Rp', '').trim(); // Remove 'Rp ' for easier number input
            }
        });

        addBankAccountBtn.addEventListener('click', () => {
            const name = bankAccountNameInput.value.trim();
            const balance = parseRupiah(bankAccountBalanceInput.value); // Parse to number

            if (!name || isNaN(balance)) {
                alert('Nama Bank/Akun dan Saldo Awal tidak boleh kosong atau tidak valid.');
                return;
            }

            database.ref('bankAccounts').push({
                name: name,
                balance: balance, // Store as number
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                alert('Akun Bank berhasil ditambahkan!');
                bankAccountNameInput.value = '';
                bankAccountBalanceInput.value = '';
                loadBankAccounts(); // Refresh list
                loadBankReportDropdown(); // Refresh dropdown for bank report
            }).catch(error => {
                console.error("Error adding bank account:", error);
                alert('Gagal menambahkan Akun Bank: ' + error.message);
            });
        });

        function loadBankAccounts() {
            database.ref('bankAccounts').on('value', snapshot => {
                bankAccountsList.innerHTML = ''; // Clear existing list
                allBankAccountsData = snapshot.val() || {}; // Cache all bank accounts data

                if (Object.keys(allBankAccountsData).length === 0) {
                    bankAccountsList.innerHTML = '<li class="text-center">Belum ada rekening bank.</li>';
                } else {
                    // Calculate total current bank balance across all accounts
                    let totalBankBalance = 0;
                    const sortedAccounts = Object.keys(allBankAccountsData).map(key => ({ id: key, ...allBankAccountsData[key] }))
                                            .sort((a, b) => a.name.localeCompare(b.name));

                    sortedAccounts.forEach(account => {
                        totalBankBalance += (account.balance || 0);
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <span>${account.name}</span>
                            <span class="balance">${formatRupiah(account.balance || 0)}</span>
                            <div class="bank-actions">
                                <button class="btn btn-warning" onclick="editBankAccount('${account.id}')"><i class="fas fa-edit"></i> Edit</button>
                                <button class="btn btn-danger" onclick="deleteBankAccount('${account.id}')"><i class="fas fa-trash-alt"></i> Hapus</button>
                            </div>
                        `;
                        bankAccountsList.appendChild(listItem);
                    });
                    totalCurrentBankBalance.textContent = formatRupiah(totalBankBalance);
                }
            }, error => {
                console.error("Error loading bank accounts:", error);
                bankAccountsList.innerHTML = '<li class="text-center" style="color: red;">Gagal memuat rekening bank.</li>';
            });
        }

        window.editBankAccount = function(id) {
            database.ref('bankAccounts/' + id).once('value', snapshot => {
                const account = snapshot.val();
                const newName = prompt('Edit Nama Bank/Akun:', account.name);
                if (newName === null || newName.trim() === '') return;

                let newBalance = prompt('Edit Saldo (Rp):', account.balance);
                newBalance = parseRupiah(newBalance); // Use parseRupiah to convert input string to number

                if (isNaN(newBalance)) {
                    alert('Saldo tidak valid.');
                    return;
                }

                database.ref('bankAccounts/' + id).update({
                    name: newName.trim(),
                    balance: newBalance
                }).then(() => {
                    alert('Rekening bank berhasil diperbarui!');
                    // loadBankAccounts() will refresh via 'on' listener
                }).catch(error => {
                    console.error("Error updating bank account:", error);
                    alert('Gagal memperbarui rekening bank: ' + error.message);
                });
            }).catch(error => {
                console.error("Error fetching bank account for edit:", error);
                alert('Gagal memuat data rekening untuk diedit.');
            });
        };

        window.deleteBankAccount = function(id) {
            if (confirm('Apakah Anda yakin ingin menghapus rekening ini?')) {
                database.ref('bankAccounts/' + id).remove()
                    .then(() => {
                        alert('Rekening bank berhasil dihapus!');
                        // loadBankAccounts() will refresh via 'on' listener
                    })
                    .catch(error => {
                        console.error('Error deleting bank account:', error);
                        alert('Gagal menghapus rekening bank: ' + error.message);
                    });
            }
        };

        // --- Laporan Outstanding Saldo Bank / Mutasi Kas ---
        generateBankReportBtn.addEventListener('click', generateBankReport);
        downloadBankPdfBtn.addEventListener('click', downloadBankPdfReport);
        bankReportAccountSelect.addEventListener('change', generateBankReport);

        function loadBankReportDropdown() {
            bankReportAccountSelect.innerHTML = '<option value="all">Semua Akun Bank</option>';
            for (let id in allBankAccountsData) {
                const account = allBankAccountsData[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = account.name;
                bankReportAccountSelect.appendChild(option);
            }
        }


        function generateBankReport() {
            const startDate = bankReportStartDateInput.value;
            const endDate = bankReportEndDateInput.value;
            const selectedAccountId = bankReportAccountSelect.value;

            if (!startDate || !endDate) {
                alert('Mohon pilih rentang tanggal untuk laporan bank.');
                return;
            }

            const startTimestamp = new Date(startDate).getTime();
            const endTimestamp = new Date(endDate);
            endTimestamp.setHours(23, 59, 59, 999);

            database.ref('transactions')
                .orderByChild('timestamp')
                .startAt(startTimestamp)
                .endAt(endTimestamp.getTime())
                .once('value', snapshot => {
                    bankOutstandingReportBody.innerHTML = '';
                    let periodTotalDebet = 0;
                    let periodTotalKredit = 0;
                    let runningBalance = 0; // This running balance is for the *selected account* or *all accounts*

                    const transactions = [];
                    snapshot.forEach(childSnapshot => {
                        transactions.push(childSnapshot.val());
                    });

                    // Sort transactions by timestamp (ascending) for running balance
                    transactions.sort((a, b) => a.timestamp - b.timestamp);

                    // Fetch initial balance for selected account(s)
                    let initialBalanceForPeriod = 0;
                    if (selectedAccountId === 'all') {
                         for (let id in allBankAccountsData) {
                            initialBalanceForPeriod += (allBankAccountsData[id].balance || 0);
                        }
                    } else if (allBankAccountsData[selectedAccountId]) {
                        initialBalanceForPeriod = allBankAccountsData[selectedAccountId].balance || 0;
                    }
                    runningBalance = initialBalanceForPeriod;

                    const filteredTransactions = transactions.filter(transaction => {
                        // Assuming all transactions affect "cash/bank" for simplicity of this report.
                        // In a real system, you'd link transactions to specific bank accounts.
                        // For this report, we'll treat all recorded debits as bank inflows and credits as bank outflows.
                        // If specific bank account linkage is needed, transactions would need a 'bankAccountId' field.
                        return true; // All transactions are considered for now
                    });

                    if (filteredTransactions.length === 0) {
                        bankOutstandingReportBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada mutasi kas/bank dalam periode ini.</td></tr>';
                    } else {
                        filteredTransactions.forEach(transaction => {
                            const row = bankOutstandingReportBody.insertRow();
                            const date = new Date(transaction.timestamp).toLocaleDateString('id-ID');
                            const debetAmount = parseFloat(transaction.debet || 0);
                            const kreditAmount = parseFloat(transaction.kredit || 0);

                            if (transaction.type === 'debet') {
                                runningBalance += debetAmount;
                            } else if (transaction.type === 'kredit') {
                                runningBalance -= kreditAmount;
                            }

                            row.insertCell(0).textContent = date;
                            row.insertCell(1).textContent = transaction.description;
                            row.insertCell(2).textContent = "N/A"; // Or add a bank account field to transactions
                            row.insertCell(3).textContent = formatRupiah(debetAmount);
                            row.insertCell(4).textContent = formatRupiah(kreditAmount);
                            row.insertCell(5).textContent = formatRupiah(runningBalance);

                            periodTotalDebet += debetAmount;
                            periodTotalKredit += kreditAmount;
                        });
                    }

                    totalBankDebet.textContent = formatRupiah(periodTotalDebet);
                    totalBankKredit.textContent = formatRupiah(periodTotalKredit);
                    finalBankBalancePeriod.textContent = formatRupiah(periodTotalDebet - periodTotalKredit);
                })
                .catch(error => {
                    console.error("Error generating bank report:", error);
                    bankOutstandingReportBody.innerHTML = '<tr><td colspan="6" class="text-center" style="color: red;">Gagal memuat laporan bank.</td></tr>';
                });
        }

        function downloadBankPdfReport() {
            alert('Fungsi Unduh PDF Laporan Bank belum diimplementasikan.');
            // This would follow a similar pattern to downloadPdfReport for transactions,
            // but targeting the bank outstanding report table.
        }


        // --- Logout Function ---
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log("User signed out.");
                window.location.href = 'login.html'; // Redirect to login page
            }).catch(error => {
                console.error("Error signing out:", error);
                alert('Gagal logout: ' + error.message);
            });
        });

    } // End of initializeApp function
</script>
